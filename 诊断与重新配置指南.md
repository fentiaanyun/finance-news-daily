# 📋 财经新闻推送系统 - 诊断与重新配置指南

## 🔍 问题诊断

您遇到的"24小时没有重要新闻"问题可能由以下原因导致：

### 1️⃣ **RSS源无法访问**
- 某些RSS源可能在中国大陆无法直接访问
- 解决方案：脚本已扩展RSS源并添加了兜底机制

### 2️⃣ **时间过滤过严格**
- 原代码限制48小时内的新闻，可能导致查询为空
- 解决方案：已改为72小时，和增强兜底策略

### 3️⃣ **关键词匹配失败**
- 新闻必须完全匹配关键词才显示
- 解决方案：扩展关键词库覆盖范围，降低过滤门槛

### 4️⃣ **GitHub Secrets配置不完整**
- Server酱SendKey未正确配置
- Secrets格式或值错误
- 解决方案：详细的配置步骤见下方

---

## ✅ 重新配置步骤

### 第一步：获取必要的密钥和令牌

#### 1. **Server酱密钥（必需 - 用于微信推送）**

1. 访问 [Server酱官网](https://sctapi.ftqq.com/)
2. **用微信扫码登录** ⚠️ 重要：必须用微信APP扫码，不能用手机浏览器
3. 登录后进入"发送消息"页面
4. 找到蓝色的 `SendKey` - **复制这个值**
5. 格式应该像：`SCT...` (很长的字符串)

**验证SendKey是否有效：**
```bash
# 在本地终端测试（替换YOUR_SEND_KEY）
curl -X POST https://sctapi.ftqq.com/YOUR_SEND_KEY.send \
  -d "title=测试" \
  -d "desp=这是一条测试消息"
```
如果返回 `"code":0`，说明SendKey正确。

#### 2. **邮箱配置（QQ邮箱推荐）**

**获取QQ邮箱授权码：**
1. 登录 [QQ邮箱](https://mail.qq.com)
2. 点击右上角 **"设置"** → **"账户"**
3. 向下滚动找到 **"POP3/IMAP/SMTP服务"**
4. 点击 **"开启"** (需要手机验证，发送短信)
5. 开启后，点击 **"生成授权码"**
6. 按提示发送短信后，会显示 **16位授权码**
7. ⚠️ **立即复制保存这个授权码** (只显示一次)

**其他邮箱配置：**

| 邮箱 | SMTP服务器 | SMTP端口 | 授权码获取 |
|------|-----------|--------|---------|
| QQ | smtp.qq.com | 587 (或465) | QQ邮箱设置→账户→生成授权码 |
| Gmail | smtp.gmail.com | 587 | Google账户→安全→应用专用密码 |
| 163 | smtp.163.com | 587 | 163邮箱设置→授权码管理 |

#### 3. **NewsAPI密钥（可选 - 国际新闻）**
- 访问 [NewsAPI官网](https://newsapi.org/)
- 注册并获取API密钥
- 免费版有请求限制（可选配置）

---

### 第二步：在GitHub中配置Secrets  

1. **打开GitHub仓库**
   - 访问：https://github.com/YOUR_USERNAME/finance-news-daily
   - 点击 **Settings** 标签

2. **打开Secrets配置**
   - 左侧菜单 → **Secrets and variables** → **Actions**
   - 点击 **New repository secret** 按钮

3. **添加以下Secrets**（按顺序添加）

#### 📱 **SERVERCHAN_SEND_KEY** (必需!)
```
Name: SERVERCHAN_SEND_KEY
Value: 你从Server酱获取的SendKey
例如：SCT....(很长的字符串)
```

#### 📧 **EMAIL_SENDER** (接收推送的邮箱)
```
Name: EMAIL_SENDER
Value: 23950413@qq.com  (替换为你的邮箱)
```

#### 🔐 **EMAIL_PASSWORD** (邮箱授权码)
```
Name: EMAIL_PASSWORD
Value: 你的16位授权码 (例如: abcdefghijklmnop)
⚠️ 重要：这是授权码，不是邮箱密码！
```

#### 📬 **EMAIL_RECIPIENT** (接收者邮箱，可与上面相同)
```
Name: EMAIL_RECIPIENT
Value: 23950413@qq.com  (可与EMAIL_SENDER相同)
```

#### 🖥️ **SMTP_SERVER** (邮箱SMTP服务器)
```
Name: SMTP_SERVER
Value: smtp.qq.com  (QQ邮箱)
        或 smtp.gmail.com  (Gmail)
        或 smtp.163.com  (163邮箱)
```

#### 🔌 **SMTP_PORT** (SMTP端口)
```
Name: SMTP_PORT
Value: 587  (或 465)
```

#### 📰 **NEWS_API_KEY** (可选 - 国际新闻API)
```
Name: NEWS_API_KEY
Value: 你的NewsAPI密钥
(如果不需要国际新闻可以不配置)
```

---

### 第三步：测试配置

1. **访问Actions页面**
   - 在仓库中点击 **Actions** 标签

2. **手动运行工作流**
   - 找到 "每日财经新闻推送" 工作流
   - 点击右侧 **Run workflow** → **Run workflow**

3. **等待执行完成**
   - 通常需要1-2分钟
   - 查看执行日志检查是否有错误

4. **验证推送**
   - ✅ 检查微信是否收到消息
   - ✅ 检查邮箱是否收到邮件
   - ✅ 如果都收到了，说明配置成功！

---

## 🐛 常见问题排查

### Q: 微信没收到推送，显示"SERVERCHAN_SEND_KEY未配置"

**A:** 
1. 检查SendKey是否真的复制到GitHub Secrets了？
2. Secret的名称是否完全匹配 `SERVERCHAN_SEND_KEY`（大小写）？
3. 尝试手动运行一次工作流：Actions → Run workflow

### Q: 邮件没收到，提示"认证失败"

**A:**
1. **检查授权码是否正确**（不是QQ密码）
2. QQ邮箱是否开启了SMTP服务？
   - 进入 QQ邮箱 → 设置 → 账户
   - 找 "POP3/IMAP/SMTP服务" → 确保已"开启"
3. 如果用Gmail，确保已开启 "应用专用密码"
4. 如果是163邮箱，确保已开启服务并获取授权码

### Q: 任务运行但没有新闻数据

**A:**
1. **脚本已改进**，会自动从多个RSS源获取新闻
2. 如果仍然为空，可能是：
   - 网络问题：在GitHub Actions中某些源可能无法访问
   - 时间问题：更改工作流时间，确保在中国时间白天运行
   - 解决方案：手动运行一次看日志输出

### Q: 想看到更多的日志信息排查问题

**A:**
1. 在仓库的 **Actions** 标签中运行工作流
2. 点击最近的运行记录
3. 点击 "Run fetch-and-send-news script" 展开查看详细日志

### Q: 怎样在本地测试脚本？

**A:** 
在本地终端运行（Windows需要设置环境变量）：
```powershell
# Windows PowerShell
$env:SERVERCHAN_SEND_KEY="你的SendKey"
$env:EMAIL_SENDER="你的邮箱"
$env:EMAIL_PASSWORD="授权码"
$env:EMAIL_RECIPIENT="接收邮箱"
$env:SMTP_SERVER="smtp.qq.com"
$env:SMTP_PORT="587"

python fetch_news.py
```

---

## 📊 脚本改进内容

已完成以下改进来解决问题：

### 1. **扩展RSS源** ✅
- 添加多个备用RSS源
- 增强了在网络不稳定时的容错能力
- 添加SSL验证忽略选项（某些源证书问题）

### 2. **放宽时间限制** ✅
- 从48小时放宽到72小时
- 如果72小时内无新闻，自动兜底获取任何时间的新闻

### 3. **扩展关键词库** ✅
- 从20个扩展到30+个关键词
- 包括股票、涨跌、价格、指数等常见词汇
- 任意匹配都算"有效新闻"

### 4. **改进格式化输出** ✅
- 显示新闻统计（重要新闻数、总数）
- 区分"重要新闻"和"其他新闻"分类显示
- 显示发布时间（刚刚、N小时前、N天前）

### 5. **增强错误诊断** ✅
- 详细的错误信息和解决建议
- 显示具体的连接日志
- 协助快速定位问题

---

## ✨ 预期效果

配置完成后，您应该看到：

```
📊 财经早报 - 2026年02月08日 08:00:00
==================================================

📈 统计信息
  • 总新闻数：25 条
  • 重要新闻：8 条
  • 更新时间：2026-02-08 08:00:00

⭐ 【重要新闻】
--------------------------------------------------
1. 【新浪财经】美联储维持基准利率不变 (2小时前)
   美国联邦公开市场委员会宣布...
   🔗 https://...

2. 【东方财富】央行发布最新货币政策声明 (3小时前)
   中国人民银行表示...
   🔗 https://...

...

📰 【其他新闻】(显示前10条)
--------------------------------------------------
1. 【新浪股票】A股收盘涨0.8% (5小时前)
...

==================================================
✨ 更多财经资讯请访问：新浪财经、东方财富
```

---

## 🚀 定时运行

- **默认时间**：每天早上8点（北京时间）
- **可手动触发**：Actions页面 → Run workflow
- **修改时间**：编辑 `.github/workflows/daily-news.yml`

如需修改时间，编辑以下部分：
```yaml
- cron: '0 0 * * *'  # UTC 0点 = 北京时间8点
       # 分 时 天 月 周

# 改为北京时间10点（UTC 2点）：
- cron: '0 2 * * *'

# 改为北京时间20点（UTC 12点）：
- cron: '0 12 * * *'
```

---

## 📞 需要帮助？

如果问题仍未解决：
1. 检查GitHub Actions日志获取详细错误信息
2. 验证所有的Secrets配置（特别是大小写）
3. 测试SendKey是否真的有效：使用curl命令测试
4. 检查邮箱SMTP服务是否已开启

---

**祝您顺利！Let's get the financial news flowing！** 📰💰
